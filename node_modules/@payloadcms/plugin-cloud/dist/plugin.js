"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "payloadCloud", {
    enumerable: true,
    get: function() {
        return payloadCloud;
    }
});
const _email = require("./email");
const _afterDelete = require("./hooks/afterDelete");
const _beforeChange = require("./hooks/beforeChange");
const _uploadCache = require("./hooks/uploadCache");
const _staticHandler = require("./staticHandler");
const _webpack = require("./webpack");
const payloadCloud = (pluginOptions)=>(incomingConfig)=>{
        let config = {
            ...incomingConfig
        };
        const webpack = (0, _webpack.extendWebpackConfig)(incomingConfig);
        config.admin = {
            ...config.admin || {},
            webpack
        };
        if (process.env.PAYLOAD_CLOUD !== 'true') {
            return config // only modified webpack
            ;
        }
        const cachingEnabled = pluginOptions?.uploadCaching !== false && !!process.env.PAYLOAD_CLOUD_CACHE_KEY;
        const apiEndpoint = pluginOptions?.endpoint || 'https://cloud-api.payloadcms.com';
        // Configure cloud storage
        if (pluginOptions?.storage !== false) {
            config = {
                ...config,
                collections: (config.collections || []).map((collection)=>{
                    if (collection.upload) {
                        return {
                            ...collection,
                            hooks: {
                                ...collection.hooks || {},
                                afterChange: [
                                    ...collection.hooks?.afterChange || [],
                                    ...cachingEnabled ? [
                                        (0, _uploadCache.getCacheUploadsAfterChangeHook)({
                                            endpoint: apiEndpoint
                                        })
                                    ] : []
                                ],
                                afterDelete: [
                                    ...collection.hooks?.afterDelete || [],
                                    (0, _afterDelete.getAfterDeleteHook)({
                                        collection
                                    }),
                                    ...cachingEnabled ? [
                                        (0, _uploadCache.getCacheUploadsAfterDeleteHook)({
                                            endpoint: apiEndpoint
                                        })
                                    ] : []
                                ],
                                beforeChange: [
                                    ...collection.hooks?.beforeChange || [],
                                    (0, _beforeChange.getBeforeChangeHook)({
                                        collection
                                    })
                                ]
                            },
                            upload: {
                                ...typeof collection.upload === 'object' ? collection.upload : {},
                                disableLocalStorage: true,
                                handlers: [
                                    ...typeof collection.upload === 'object' && Array.isArray(collection.upload.handlers) ? collection.upload.handlers : [],
                                    (0, _staticHandler.getStaticHandler)({
                                        cachingOptions: pluginOptions?.uploadCaching,
                                        collection
                                    })
                                ]
                            }
                        };
                    }
                    return collection;
                }),
                upload: {
                    ...config.upload || {},
                    useTempFiles: true
                }
            };
        }
        // Configure cloud email
        const apiKey = process.env.PAYLOAD_CLOUD_EMAIL_API_KEY;
        const defaultDomain = process.env.PAYLOAD_CLOUD_DEFAULT_DOMAIN;
        if (pluginOptions?.email !== false && apiKey && defaultDomain) {
            config.email = (0, _email.payloadCloudEmail)({
                apiKey,
                config,
                defaultDomain
            });
        }
        return config;
    };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wbHVnaW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDb25maWcgfSBmcm9tICdwYXlsb2FkL2NvbmZpZydcblxuaW1wb3J0IHR5cGUgeyBQbHVnaW5PcHRpb25zIH0gZnJvbSAnLi90eXBlcydcblxuaW1wb3J0IHsgcGF5bG9hZENsb3VkRW1haWwgfSBmcm9tICcuL2VtYWlsJ1xuaW1wb3J0IHsgZ2V0QWZ0ZXJEZWxldGVIb29rIH0gZnJvbSAnLi9ob29rcy9hZnRlckRlbGV0ZSdcbmltcG9ydCB7IGdldEJlZm9yZUNoYW5nZUhvb2sgfSBmcm9tICcuL2hvb2tzL2JlZm9yZUNoYW5nZSdcbmltcG9ydCB7IGdldENhY2hlVXBsb2Fkc0FmdGVyQ2hhbmdlSG9vaywgZ2V0Q2FjaGVVcGxvYWRzQWZ0ZXJEZWxldGVIb29rIH0gZnJvbSAnLi9ob29rcy91cGxvYWRDYWNoZSdcbmltcG9ydCB7IGdldFN0YXRpY0hhbmRsZXIgfSBmcm9tICcuL3N0YXRpY0hhbmRsZXInXG5pbXBvcnQgeyBleHRlbmRXZWJwYWNrQ29uZmlnIH0gZnJvbSAnLi93ZWJwYWNrJ1xuXG5leHBvcnQgY29uc3QgcGF5bG9hZENsb3VkID1cbiAgKHBsdWdpbk9wdGlvbnM/OiBQbHVnaW5PcHRpb25zKSA9PlxuICAoaW5jb21pbmdDb25maWc6IENvbmZpZyk6IENvbmZpZyA9PiB7XG4gICAgbGV0IGNvbmZpZyA9IHsgLi4uaW5jb21pbmdDb25maWcgfVxuICAgIGNvbnN0IHdlYnBhY2sgPSBleHRlbmRXZWJwYWNrQ29uZmlnKGluY29taW5nQ29uZmlnKVxuXG4gICAgY29uZmlnLmFkbWluID0ge1xuICAgICAgLi4uKGNvbmZpZy5hZG1pbiB8fCB7fSksXG4gICAgICB3ZWJwYWNrLFxuICAgIH1cblxuICAgIGlmIChwcm9jZXNzLmVudi5QQVlMT0FEX0NMT1VEICE9PSAndHJ1ZScpIHtcbiAgICAgIHJldHVybiBjb25maWcgLy8gb25seSBtb2RpZmllZCB3ZWJwYWNrXG4gICAgfVxuXG4gICAgY29uc3QgY2FjaGluZ0VuYWJsZWQgPVxuICAgICAgcGx1Z2luT3B0aW9ucz8udXBsb2FkQ2FjaGluZyAhPT0gZmFsc2UgJiYgISFwcm9jZXNzLmVudi5QQVlMT0FEX0NMT1VEX0NBQ0hFX0tFWVxuXG4gICAgY29uc3QgYXBpRW5kcG9pbnQgPSBwbHVnaW5PcHRpb25zPy5lbmRwb2ludCB8fCAnaHR0cHM6Ly9jbG91ZC1hcGkucGF5bG9hZGNtcy5jb20nXG5cbiAgICAvLyBDb25maWd1cmUgY2xvdWQgc3RvcmFnZVxuICAgIGlmIChwbHVnaW5PcHRpb25zPy5zdG9yYWdlICE9PSBmYWxzZSkge1xuICAgICAgY29uZmlnID0ge1xuICAgICAgICAuLi5jb25maWcsXG4gICAgICAgIGNvbGxlY3Rpb25zOiAoY29uZmlnLmNvbGxlY3Rpb25zIHx8IFtdKS5tYXAoKGNvbGxlY3Rpb24pID0+IHtcbiAgICAgICAgICBpZiAoY29sbGVjdGlvbi51cGxvYWQpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIC4uLmNvbGxlY3Rpb24sXG4gICAgICAgICAgICAgIGhvb2tzOiB7XG4gICAgICAgICAgICAgICAgLi4uKGNvbGxlY3Rpb24uaG9va3MgfHwge30pLFxuICAgICAgICAgICAgICAgIGFmdGVyQ2hhbmdlOiBbXG4gICAgICAgICAgICAgICAgICAuLi4oY29sbGVjdGlvbi5ob29rcz8uYWZ0ZXJDaGFuZ2UgfHwgW10pLFxuICAgICAgICAgICAgICAgICAgLi4uKGNhY2hpbmdFbmFibGVkXG4gICAgICAgICAgICAgICAgICAgID8gW2dldENhY2hlVXBsb2Fkc0FmdGVyQ2hhbmdlSG9vayh7IGVuZHBvaW50OiBhcGlFbmRwb2ludCB9KV1cbiAgICAgICAgICAgICAgICAgICAgOiBbXSksXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBhZnRlckRlbGV0ZTogW1xuICAgICAgICAgICAgICAgICAgLi4uKGNvbGxlY3Rpb24uaG9va3M/LmFmdGVyRGVsZXRlIHx8IFtdKSxcbiAgICAgICAgICAgICAgICAgIGdldEFmdGVyRGVsZXRlSG9vayh7IGNvbGxlY3Rpb24gfSksXG4gICAgICAgICAgICAgICAgICAuLi4oY2FjaGluZ0VuYWJsZWRcbiAgICAgICAgICAgICAgICAgICAgPyBbZ2V0Q2FjaGVVcGxvYWRzQWZ0ZXJEZWxldGVIb29rKHsgZW5kcG9pbnQ6IGFwaUVuZHBvaW50IH0pXVxuICAgICAgICAgICAgICAgICAgICA6IFtdKSxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIGJlZm9yZUNoYW5nZTogW1xuICAgICAgICAgICAgICAgICAgLi4uKGNvbGxlY3Rpb24uaG9va3M/LmJlZm9yZUNoYW5nZSB8fCBbXSksXG4gICAgICAgICAgICAgICAgICBnZXRCZWZvcmVDaGFuZ2VIb29rKHsgY29sbGVjdGlvbiB9KSxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB1cGxvYWQ6IHtcbiAgICAgICAgICAgICAgICAuLi4odHlwZW9mIGNvbGxlY3Rpb24udXBsb2FkID09PSAnb2JqZWN0JyA/IGNvbGxlY3Rpb24udXBsb2FkIDoge30pLFxuICAgICAgICAgICAgICAgIGRpc2FibGVMb2NhbFN0b3JhZ2U6IHRydWUsXG4gICAgICAgICAgICAgICAgaGFuZGxlcnM6IFtcbiAgICAgICAgICAgICAgICAgIC4uLih0eXBlb2YgY29sbGVjdGlvbi51cGxvYWQgPT09ICdvYmplY3QnICYmXG4gICAgICAgICAgICAgICAgICBBcnJheS5pc0FycmF5KGNvbGxlY3Rpb24udXBsb2FkLmhhbmRsZXJzKVxuICAgICAgICAgICAgICAgICAgICA/IGNvbGxlY3Rpb24udXBsb2FkLmhhbmRsZXJzXG4gICAgICAgICAgICAgICAgICAgIDogW10pLFxuICAgICAgICAgICAgICAgICAgZ2V0U3RhdGljSGFuZGxlcih7XG4gICAgICAgICAgICAgICAgICAgIGNhY2hpbmdPcHRpb25zOiBwbHVnaW5PcHRpb25zPy51cGxvYWRDYWNoaW5nLFxuICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uLFxuICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gY29sbGVjdGlvblxuICAgICAgICB9KSxcbiAgICAgICAgdXBsb2FkOiB7XG4gICAgICAgICAgLi4uKGNvbmZpZy51cGxvYWQgfHwge30pLFxuICAgICAgICAgIHVzZVRlbXBGaWxlczogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDb25maWd1cmUgY2xvdWQgZW1haWxcbiAgICBjb25zdCBhcGlLZXkgPSBwcm9jZXNzLmVudi5QQVlMT0FEX0NMT1VEX0VNQUlMX0FQSV9LRVlcbiAgICBjb25zdCBkZWZhdWx0RG9tYWluID0gcHJvY2Vzcy5lbnYuUEFZTE9BRF9DTE9VRF9ERUZBVUxUX0RPTUFJTlxuICAgIGlmIChwbHVnaW5PcHRpb25zPy5lbWFpbCAhPT0gZmFsc2UgJiYgYXBpS2V5ICYmIGRlZmF1bHREb21haW4pIHtcbiAgICAgIGNvbmZpZy5lbWFpbCA9IHBheWxvYWRDbG91ZEVtYWlsKHtcbiAgICAgICAgYXBpS2V5LFxuICAgICAgICBjb25maWcsXG4gICAgICAgIGRlZmF1bHREb21haW4sXG4gICAgICB9KVxuICAgIH1cblxuICAgIHJldHVybiBjb25maWdcbiAgfVxuIl0sIm5hbWVzIjpbInBheWxvYWRDbG91ZCIsInBsdWdpbk9wdGlvbnMiLCJpbmNvbWluZ0NvbmZpZyIsImNvbmZpZyIsIndlYnBhY2siLCJleHRlbmRXZWJwYWNrQ29uZmlnIiwiYWRtaW4iLCJwcm9jZXNzIiwiZW52IiwiUEFZTE9BRF9DTE9VRCIsImNhY2hpbmdFbmFibGVkIiwidXBsb2FkQ2FjaGluZyIsIlBBWUxPQURfQ0xPVURfQ0FDSEVfS0VZIiwiYXBpRW5kcG9pbnQiLCJlbmRwb2ludCIsInN0b3JhZ2UiLCJjb2xsZWN0aW9ucyIsIm1hcCIsImNvbGxlY3Rpb24iLCJ1cGxvYWQiLCJob29rcyIsImFmdGVyQ2hhbmdlIiwiZ2V0Q2FjaGVVcGxvYWRzQWZ0ZXJDaGFuZ2VIb29rIiwiYWZ0ZXJEZWxldGUiLCJnZXRBZnRlckRlbGV0ZUhvb2siLCJnZXRDYWNoZVVwbG9hZHNBZnRlckRlbGV0ZUhvb2siLCJiZWZvcmVDaGFuZ2UiLCJnZXRCZWZvcmVDaGFuZ2VIb29rIiwiZGlzYWJsZUxvY2FsU3RvcmFnZSIsImhhbmRsZXJzIiwiQXJyYXkiLCJpc0FycmF5IiwiZ2V0U3RhdGljSGFuZGxlciIsImNhY2hpbmdPcHRpb25zIiwidXNlVGVtcEZpbGVzIiwiYXBpS2V5IiwiUEFZTE9BRF9DTE9VRF9FTUFJTF9BUElfS0VZIiwiZGVmYXVsdERvbWFpbiIsIlBBWUxPQURfQ0xPVURfREVGQVVMVF9ET01BSU4iLCJlbWFpbCIsInBheWxvYWRDbG91ZEVtYWlsIl0sIm1hcHBpbmdzIjoiOzs7OytCQVdhQTs7O2VBQUFBOzs7dUJBUHFCOzZCQUNDOzhCQUNDOzZCQUMyQzsrQkFDOUM7eUJBQ0c7QUFFN0IsTUFBTUEsZUFDWCxDQUFDQyxnQkFDRCxDQUFDQztRQUNDLElBQUlDLFNBQVM7WUFBRSxHQUFHRCxjQUFjO1FBQUM7UUFDakMsTUFBTUUsVUFBVUMsSUFBQUEsNEJBQW1CLEVBQUNIO1FBRXBDQyxPQUFPRyxLQUFLLEdBQUc7WUFDYixHQUFJSCxPQUFPRyxLQUFLLElBQUksQ0FBQyxDQUFDO1lBQ3RCRjtRQUNGO1FBRUEsSUFBSUcsUUFBUUMsR0FBRyxDQUFDQyxhQUFhLEtBQUssUUFBUTtZQUN4QyxPQUFPTixPQUFPLHdCQUF3Qjs7UUFDeEM7UUFFQSxNQUFNTyxpQkFDSlQsZUFBZVUsa0JBQWtCLFNBQVMsQ0FBQyxDQUFDSixRQUFRQyxHQUFHLENBQUNJLHVCQUF1QjtRQUVqRixNQUFNQyxjQUFjWixlQUFlYSxZQUFZO1FBRS9DLDBCQUEwQjtRQUMxQixJQUFJYixlQUFlYyxZQUFZLE9BQU87WUFDcENaLFNBQVM7Z0JBQ1AsR0FBR0EsTUFBTTtnQkFDVGEsYUFBYSxBQUFDYixDQUFBQSxPQUFPYSxXQUFXLElBQUksRUFBRSxBQUFELEVBQUdDLEdBQUcsQ0FBQyxDQUFDQztvQkFDM0MsSUFBSUEsV0FBV0MsTUFBTSxFQUFFO3dCQUNyQixPQUFPOzRCQUNMLEdBQUdELFVBQVU7NEJBQ2JFLE9BQU87Z0NBQ0wsR0FBSUYsV0FBV0UsS0FBSyxJQUFJLENBQUMsQ0FBQztnQ0FDMUJDLGFBQWE7dUNBQ1BILFdBQVdFLEtBQUssRUFBRUMsZUFBZSxFQUFFO3VDQUNuQ1gsaUJBQ0E7d0NBQUNZLElBQUFBLDJDQUE4QixFQUFDOzRDQUFFUixVQUFVRDt3Q0FBWTtxQ0FBRyxHQUMzRCxFQUFFO2lDQUNQO2dDQUNEVSxhQUFhO3VDQUNQTCxXQUFXRSxLQUFLLEVBQUVHLGVBQWUsRUFBRTtvQ0FDdkNDLElBQUFBLCtCQUFrQixFQUFDO3dDQUFFTjtvQ0FBVzt1Q0FDNUJSLGlCQUNBO3dDQUFDZSxJQUFBQSwyQ0FBOEIsRUFBQzs0Q0FBRVgsVUFBVUQ7d0NBQVk7cUNBQUcsR0FDM0QsRUFBRTtpQ0FDUDtnQ0FDRGEsY0FBYzt1Q0FDUlIsV0FBV0UsS0FBSyxFQUFFTSxnQkFBZ0IsRUFBRTtvQ0FDeENDLElBQUFBLGlDQUFtQixFQUFDO3dDQUFFVDtvQ0FBVztpQ0FDbEM7NEJBQ0g7NEJBQ0FDLFFBQVE7Z0NBQ04sR0FBSSxPQUFPRCxXQUFXQyxNQUFNLEtBQUssV0FBV0QsV0FBV0MsTUFBTSxHQUFHLENBQUMsQ0FBQztnQ0FDbEVTLHFCQUFxQjtnQ0FDckJDLFVBQVU7dUNBQ0osT0FBT1gsV0FBV0MsTUFBTSxLQUFLLFlBQ2pDVyxNQUFNQyxPQUFPLENBQUNiLFdBQVdDLE1BQU0sQ0FBQ1UsUUFBUSxJQUNwQ1gsV0FBV0MsTUFBTSxDQUFDVSxRQUFRLEdBQzFCLEVBQUU7b0NBQ05HLElBQUFBLCtCQUFnQixFQUFDO3dDQUNmQyxnQkFBZ0JoQyxlQUFlVTt3Q0FDL0JPO29DQUNGO2lDQUNEOzRCQUNIO3dCQUNGO29CQUNGO29CQUVBLE9BQU9BO2dCQUNUO2dCQUNBQyxRQUFRO29CQUNOLEdBQUloQixPQUFPZ0IsTUFBTSxJQUFJLENBQUMsQ0FBQztvQkFDdkJlLGNBQWM7Z0JBQ2hCO1lBQ0Y7UUFDRjtRQUVBLHdCQUF3QjtRQUN4QixNQUFNQyxTQUFTNUIsUUFBUUMsR0FBRyxDQUFDNEIsMkJBQTJCO1FBQ3RELE1BQU1DLGdCQUFnQjlCLFFBQVFDLEdBQUcsQ0FBQzhCLDRCQUE0QjtRQUM5RCxJQUFJckMsZUFBZXNDLFVBQVUsU0FBU0osVUFBVUUsZUFBZTtZQUM3RGxDLE9BQU9vQyxLQUFLLEdBQUdDLElBQUFBLHdCQUFpQixFQUFDO2dCQUMvQkw7Z0JBQ0FoQztnQkFDQWtDO1lBQ0Y7UUFDRjtRQUVBLE9BQU9sQztJQUNUIn0=